name: Validate Toolbox Manifests
on:
  pull_request:
    paths:
      - "manifests/**"
      - "schemas/**"
      - "scripts/**"
      - "Makefile"
      - ".github/workflows/**"
  push:
    branches: [main, master]
    paths:
      - "manifests/**"
      - "schemas/**"
      - "scripts/**"
      - "Makefile"
      - ".github/workflows/**"
env:
  YAMLFMT_VERSION: v0.20.0
  PRETTIER_VERSION: 3.7.4
  BIOME_VERSION: 2.3.8
  JQ_VERSION: 1.8.1-r0
  YQ_VERSION: 4.49.2-r1
  RIPGREP_VERSION: 15.1.0-r0
  TAPLO_VERSION: 0.10.0-r0
  BASH_VERSION: 5.3.3-r1
  GIT_VERSION: 2.52.0-r0
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install yamlfmt
        run: |
          go install github.com/google/yamlfmt/cmd/yamlfmt@${{ env.YAMLFMT_VERSION }}
        env:
          GOBIN: ${{ github.workspace }}/bin
      - name: Add GOBIN to PATH
        run: echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
      - name: Validate manifest schema
        run: make validate-manifest
      - name: Lint workflows (yamlfmt)
        run: make lint-workflows
      - name: "Optional: quick docker build (PR confidence)"
        if: "github.event_name == 'pull_request'"
        uses: docker/build-push-action@v6
        with:
          context: .
          file: images/goneat-tools/Dockerfile
          push: false
          platforms: linux/amd64
          build-args:
            YAMLFMT_VERSION: "${{ env.YAMLFMT_VERSION }}"
            PRETTIER_VERSION: "${{ env.PRETTIER_VERSION }}"
            BIOME_VERSION: "${{ env.BIOME_VERSION }}"
            JQ_VERSION: "${{ env.JQ_VERSION }}"
            YQ_VERSION: "${{ env.YQ_VERSION }}"
            RIPGREP_VERSION: "${{ env.RIPGREP_VERSION }}"
            TAPLO_VERSION: "${{ env.TAPLO_VERSION }}"
            BASH_VERSION: "${{ env.BASH_VERSION }}"
            GIT_VERSION: "${{ env.GIT_VERSION }}"
