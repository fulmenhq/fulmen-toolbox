name: Validate Toolbox Manifests
on:
  pull_request:
    paths:
      - "manifests/**"
      - "schemas/**"
      - "scripts/**"
      - "Makefile"
      - ".github/workflows/**"
  push:
    branches: [main, master]
    paths:
      - "manifests/**"
      - "schemas/**"
      - "scripts/**"
      - "Makefile"
      - ".github/workflows/**"
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Resolve lint tool versions (from manifests)
        run: |
          echo "YAMLFMT_VERSION=$(jq -r '.tools[] | select(.name==\"yamlfmt\") | .version' manifests/tools.json)" >> "$GITHUB_ENV"
          echo "ACTIONLINT_VERSION=$(jq -r '.tools[] | select(.name==\"actionlint\") | .version' manifests/tools.json)" >> "$GITHUB_ENV"
      - name: Install yamlfmt + actionlint
        run: |
          go install github.com/google/yamlfmt/cmd/yamlfmt@${{ env.YAMLFMT_VERSION }}
          go install github.com/rhysd/actionlint/cmd/actionlint@${{ env.ACTIONLINT_VERSION }}
        env:
          GOBIN: ${{ github.workspace }}/bin
      - name: Add GOBIN to PATH
        run: echo "${{ github.workspace }}/bin" >> "$GITHUB_PATH"
      - name: Validate manifest schema
        run: make validate-manifest
      - name: Validate baseline profiles
        run: make validate-profiles
      - name: Validate curated licenses
        run: make validate-licenses
      - name: Lint workflows (yamlfmt)
        run: make lint-workflows
      - name: "Optional: quick docker build (PR confidence)"
        if: "github.event_name == 'pull_request'"
        uses: docker/build-push-action@v6
        with:
          context: .
          file: images/goneat-tools/Dockerfile
          target: runner
          push: false
          platforms: linux/amd64
